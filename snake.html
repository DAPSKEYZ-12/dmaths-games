<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algebra Snake | Protocol Alpha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Plus+Jakarta+Sans:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon: #22c55e; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; overflow: hidden; touch-action: none; }
        canvas { background: rgba(15, 23, 42, 0.5); border: 2px solid #1e293b; border-radius: 1rem; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-width: 100%; height: auto; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .control-btn { width: 65px; height: 65px; background: rgba(255,255,255,0.05); border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); }
        .difficulty-overlay { position: fixed; inset: 0; background: #020617; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="startScreen" class="difficulty-overlay p-6 text-center">
        <div class="w-16 h-16 bg-emerald-500 rounded-2xl mb-6 flex items-center justify-center shadow-lg shadow-emerald-500/20">
            <i class="fas fa-brain text-3xl"></i>
        </div>
        <h1 class="text-4xl font-black mb-2 tracking-tighter">SELECT PROTOCOL</h1>
        <p class="text-slate-400 mb-8 text-sm uppercase tracking-widest">Adjust speed and calculation depth</p>
        
        <div class="grid gap-4 w-full max-w-[300px]">
            <button onclick="startGame(400, 'easy')" class="glass p-4 rounded-2xl hover:border-emerald-500 transition-all group">
                <span class="block font-bold text-emerald-400 group-hover:scale-110 transition-transform">SIMPLE</span>
                <span class="text-[10px] text-slate-500 italic">Very Slow Pace</span>
            </button>
            <button onclick="startGame(200, 'medium')" class="glass p-4 rounded-2xl hover:border-amber-500 transition-all group">
                <span class="block font-bold text-amber-400 group-hover:scale-110 transition-transform">AVERAGE</span>
                <span class="text-[10px] text-slate-500 italic">Medium Pace</span>
            </button>
            <button onclick="startGame(80, 'hard')" class="glass p-4 rounded-2xl hover:border-red-500 transition-all group">
                <span class="block font-bold text-red-400 group-hover:scale-110 transition-transform">HARD</span>
                <span class="text-[10px] text-slate-500 italic">Normal Fast Pace</span>
            </button>
        </div>
    </div>

    <div class="w-full max-w-[500px] mb-4 flex justify-between items-center px-2">
        <a href="index.html" class="glass px-4 py-2 rounded-xl text-red-500 hover:bg-red-500/10 transition-colors">
            <i class="fas fa-power-off"></i>
        </a>
        <div class="glass px-4 py-2 rounded-xl text-center border-b-2 border-emerald-500">
            <span class="text-[10px] block uppercase text-slate-500 font-black">Score</span>
            <span id="score" class="mono text-xl font-bold text-emerald-400">0000</span>
        </div>
        <div class="glass px-4 py-2 rounded-xl text-center border-b-2 border-amber-500">
            <span class="text-[10px] block uppercase text-slate-500 font-black">Timer</span>
            <span id="timer" class="mono text-xl font-bold text-amber-400">10s</span>
        </div>
    </div>

    <div class="w-full max-w-[500px] glass p-4 rounded-2xl mb-4 text-center border-l-4 border-emerald-500 mx-2">
        <p class="text-[10px] uppercase font-bold text-emerald-500 mb-1 tracking-widest">Target Equation</p>
        <h2 id="equation" class="text-2xl md:text-3xl font-black mono tracking-tighter">Solving...</h2>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>

    <div class="mt-6 grid grid-cols-3 gap-3 md:hidden">
        <div></div>
        <button class="control-btn shadow-lg" onclick="changeDir('UP')"><i class="fas fa-chevron-up"></i></button>
        <div></div>
        <button class="control-btn shadow-lg" onclick="changeDir('LEFT')"><i class="fas fa-chevron-left"></i></button>
        <button class="control-btn shadow-lg" onclick="changeDir('DOWN')"><i class="fas fa-chevron-down"></i></button>
        <button class="control-btn shadow-lg" onclick="changeDir('RIGHT')"><i class="fas fa-chevron-right"></i></button>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const box = 25; 
        let score = 0;
        let gameTimer = 10;
        let snake = [{x: 8 * box, y: 8 * box}];
        let food = [];
        let particles = []; // Array for explosion effect
        let d = "RIGHT";
        let nextD = "RIGHT"; 
        let currentAnswer = 0;
        let gameInterval;
        let timerInterval;
        let currentDifficulty = 'easy';

        function saveHighScore(value) {
            const best = Number(localStorage.getItem('snake-highscore') || 0);
            if (value > best) localStorage.setItem('snake-highscore', String(value));
        }

        function createExplosion(x, y) {
            for(let i = 0; i < 20; i++) {
                particles.push({
                    x: x + box/2,
                    y: y + box/2,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    alpha: 1,
                    color: "#22c55e"
                });
            }
        }

        function generateProblem() {
            let x, a, b, result, problemStr;
            if (currentDifficulty === 'easy') {
                x = Math.floor(Math.random() * 10) + 1;
                b = Math.floor(Math.random() * 20) + 1;
                result = x + b;
                problemStr = `x + ${b} = ${result}`;
            } else if (currentDifficulty === 'medium') {
                x = Math.floor(Math.random() * 10) + 1;
                a = Math.floor(Math.random() * 5) + 2;
                b = Math.floor(Math.random() * 10) + 1;
                result = a * x + b;
                problemStr = `${a}x + ${b} = ${result}`;
            } else {
                x = Math.floor(Math.random() * 12) + 1;
                a = Math.floor(Math.random() * 8) + 3;
                b = Math.floor(Math.random() * 15) + 5;
                result = (a * x) - b;
                problemStr = `${a}x - ${b} = ${result}`;
            }
            document.getElementById("equation").innerText = problemStr;
            currentAnswer = x;
            gameTimer = currentDifficulty === 'hard' ? 7 : 10;
            food = [];
            const correctIndex = Math.floor(Math.random() * 3);
            for(let i=0; i<3; i++) {
                let val = (i === correctIndex) ? x : x + (Math.floor(Math.random() * 5) + 1) * (Math.random() > 0.5 ? 1 : -1);
                if(val < 1) val = Math.abs(val) + 2;
                if(i !== correctIndex && val === x) val++;
                food.push({
                    x: Math.floor(Math.random() * (canvas.width/box)) * box,
                    y: Math.floor(Math.random() * (canvas.height/box)) * box,
                    val: val
                });
            }
        }

        function changeDir(dir) {
            if(dir == "LEFT" && d != "RIGHT") nextD = "LEFT";
            if(dir == "UP" && d != "DOWN") nextD = "UP";
            if(dir == "RIGHT" && d != "LEFT") nextD = "RIGHT";
            if(dir == "DOWN" && d != "UP") nextD = "DOWN";
        }

        document.addEventListener("keydown", (e) => {
            if(e.keyCode == 37) changeDir("LEFT");
            if(e.keyCode == 38) changeDir("UP");
            if(e.keyCode == 39) changeDir("RIGHT");
            if(e.keyCode == 40) changeDir("DOWN");
        });

        function gameOver() {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            saveHighScore(score);
            alert("SYSTEM CRASHED. Final Score: " + score);
            window.location.href = 'index.html';
        }

        function draw() {
            d = nextD;
            let headX = snake[0].x;
            let headY = snake[0].y;

            if(d == "LEFT") headX -= box;
            if(d == "UP") headY -= box;
            if(d == "RIGHT") headX += box;
            if(d == "DOWN") headY += box;

            const newHead = {x: headX, y: headY};

            if(headX < 0 || headX >= canvas.width || headY < 0 || headY >= canvas.height || collision(newHead, snake)) {
                createExplosion(snake[0].x, snake[0].y);
                render();
                setTimeout(gameOver, 300);
                return;
            }

            let ateCorrect = false;
            for(let i = 0; i < food.length; i++) {
                if(headX === food[i].x && headY === food[i].y) {
                    if(food[i].val === currentAnswer) {
                        score += (currentDifficulty === 'hard' ? 200 : 100);
                        document.getElementById("score").innerText = score.toString().padStart(4, '0');
                        ateCorrect = true;
                        generateProblem();
                        break;
                    } else {
                        createExplosion(headX, headY);
                        snake.unshift(newHead);
                        render();
                        setTimeout(gameOver, 300); 
                        return;
                    }
                }
            }

            snake.unshift(newHead);
            if(!ateCorrect) snake.pop();
            render();
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw particles
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.02;
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                if(p.alpha <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1;

            for(let i=0; i<snake.length; i++) {
                ctx.fillStyle = (i == 0) ? "#22c55e" : "#166534";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
                ctx.strokeStyle = "#020617";
                ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }
            food.forEach(f => {
                ctx.fillStyle = "#fbbf24";
                ctx.beginPath();
                ctx.roundRect(f.x, f.y, box, box, 5);
                ctx.fill();
                ctx.fillStyle = "black";
                ctx.font = "bold 14px JetBrains Mono";
                ctx.fillText(f.val, f.x + 5, f.y + 18);
            });
        }

        function collision(head, array) {
            for(let i=0; i<array.length; i++) {
                if(head.x == array[i].x && head.y == array[i].y) return true;
            }
            return false;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                gameTimer--;
                document.getElementById("timer").innerText = gameTimer + "s";
                if(gameTimer <= 0) {
                    if(snake.length > 1) snake.pop();
                    else gameOver();
                    generateProblem();
                }
            }, 1000);
        }

        function startGame(speed, difficulty) {
            currentDifficulty = difficulty;
            document.getElementById("startScreen").style.display = "none";
            generateProblem();
            startTimer();
            gameInterval = setInterval(draw, speed);
        }
    </script>
</body>
</html>
